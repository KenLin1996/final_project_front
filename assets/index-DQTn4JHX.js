import{a5 as ce,P as He,Q as c,R as w,S as t,c as e,V as Oe,a2 as r,a6 as oe,U as _,Z as h,a7 as Q,a8 as se,M as te,x as V,a9 as ke,o as N,a0 as o,_ as ae,T as z,G as K,W as $,X as R,Y as U,aa as re,ab as ie,N as qe,A as Se,ac as $e,z as ve,a1 as ee,a3 as Ge,$ as Ye,ad as Qe,ae as Xe,af as xe,ag as Ze,ah as Je}from"./index-D-j42ziH.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as Ke}from"./VChip-UW99AWWi.js";import{c as be,a as et,u as tt,b as we}from"./vee-validate.esm-STRXnF5i.js";import{V as at}from"./VMenu-h1IQfDTu.js";import{V as Ie,a as Ne,b as je}from"./VList-DdmDu8wS.js";import{V as ot,a as st,b as Ce,c as lt}from"./VExpansionPanels-BRigEXjh.js";import{V as j,a as m}from"./VRow-kxAzJGzz.js";import{V as nt}from"./VForm-B0joBIqd.js";import{V as rt}from"./VTextarea-B_sxWLzy.js";import{V as G}from"./VContainer-CGAFbPNq.js";import{V as Y}from"./VDivider-C-0_hfi6.js";import"./VSlideGroup-BLB6tykh.js";const ut={class:"d-flex justify-space-between align-center"},ct={__name:"BookCard",props:["_id","image","title","category","mainAuthor","content"],setup(l){const g=ce(),p=i=>{g.push(i)};return(i,y)=>{const E=He("router-link");return c(),w(se,{class:"pa-3 customMargin",width:"220"},{default:t(()=>[e(E,{to:"/stories/"+l._id},{default:t(()=>[e(Oe,{class:"cursor-pointer",height:"150px",src:l.image,cover:""},null,8,["src"])]),_:1},8,["to"]),r("div",ut,[e(oe,{class:"px-0 py-1 text-subtitle-1 cursor-pointer",onClick:y[0]||(y[0]=v=>p("/123"))},{default:t(()=>[_(h(l.title),1)]),_:1}),e(Ke,{density:"compact",color:"primary",label:"",style:{"font-size":"12px",padding:"2px 6px"}},{default:t(()=>[_(h(l.category),1)]),_:1})]),e(Q,{class:"pa-0 cursor-pointer",style:{"font-size":"12px",color:"#4e9194"},onClick:y[1]||(y[1]=v=>p("/1234"))},{default:t(()=>{var v;return[_(h((v=l.mainAuthor)==null?void 0:v.username),1)]}),_:1}),e(Q,{class:"pa-0"},{default:t(()=>[_(h(l.content[0].content[0]),1)]),_:1})]),_:1})}}},Ve=de(ct,[["__scopeId","data-v-f2bd186d"]]);function it(l){return{all:l=l||new Map,on:function(g,p){var i=l.get(g);i?i.push(p):l.set(g,[p])},off:function(g,p){var i=l.get(g);i&&(p?i.splice(i.indexOf(p)>>>0,1):l.set(g,[]))},emit:function(g,p){var i=l.get(g);i&&i.slice().map(function(y){y(p)}),(i=l.get("*"))&&i.slice().map(function(y){y(g,p)})}}}const ue=it(),dt={class:"title-row"},pt={class:"title-text"},ft={class:"card-title my-1"},mt={class:"vote-section"},ht={class:"vote-count text-body-2"},_t={__name:"VoteItem",props:["content","chapterName","author","voteCount","storyId","extensionId","voteStatus"],setup(l){const{apiAuth:g}=ie(),p=te(),i=V([{title:"檢舉"},{title:"刪除"}]),y=V(!1),E=l,{content:v,author:P,voteStatus:C,voteCount:k,storyId:I,extensionId:d}=ke(E),B=p.userId,f=N(()=>k.value.includes(B)),A=async W=>{try{(await g.patch(`/story/${I.value}/${d.value}`,{voteCountChange:W})).data.hasVotedInOtherExtension||(y.value=!0),ue.emit("updateStory")}catch(S){console.log(S),console.error("Error updating vote count:",S)}};return(W,S)=>(c(),w(se,{class:"w-100 px-6 py-2 rounded-lg",style:{border:"1px solid #48a9a6",margin:"16px 0px"}},{default:t(()=>[e(oe,{class:"pa-0"},{default:t(()=>{var b;return[r("div",dt,[r("div",pt,[r("h1",ft,h((b=o(P))==null?void 0:b.username),1)]),r("div",mt,[e(ae,{class:"vote-icon",size:"20"},{default:t(()=>[_("mdi-vote")]),_:1}),r("span",ht,h(l.voteCount.length),1),e(at,{location:"end"},{activator:t(({props:D})=>[e(z,K({icon:""},D,{class:"menu-btn",style:{width:"30px",height:"30px",padding:"auto"},variant:"plain"}),{default:t(()=>[e(ae,{size:"20"},{default:t(()=>[_("mdi-dots-vertical")]),_:1})]),_:2},1040)]),default:t(()=>[e(Ie,{class:"pa-0"},{default:t(()=>[(c(!0),$(R,null,U(i.value,(D,T)=>(c(),w(Ne,{key:T,class:""},{default:t(()=>[e(je,null,{default:t(()=>[_(h(D.title),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])])]}),_:1}),e(Q,{class:"pa-0 mx-7 py-1"},{default:t(()=>{var b;return[_(h((b=o(v))==null?void 0:b[0].latestContent),1)]}),_:1}),e(re,{class:"d-flex justify-end"},{default:t(()=>[e(z,{disabled:o(f)||o(C).hasVoted,style:{"background-color":"#f24e1e",color:"white"},onClick:S[0]||(S[0]=b=>A(1))},{default:t(()=>[_("投票")]),_:1},8,["disabled"]),e(z,{disabled:!o(f)||o(C).hasVoted&&!o(C).voteThis,style:{"background-color":"#f4b942",color:"black","margin-right":"24px"},onClick:S[1]||(S[1]=b=>A(-1))},{default:t(()=>[_("取消")]),_:1},8,["disabled"])]),_:1})]),_:1}))}},gt=de(_t,[["__scopeId","data-v-e3cc8cd3"]]),X=l=>(Ze("data-v-78af92b9"),l=l(),Je(),l),yt={class:"text--muted"},vt={class:"font-weight-black",style:{"font-size":"16px","margin-right":"4px"}},xt=X(()=>r("br",null,null,-1)),bt={key:0,class:"text--danger my-2 d-inline-block font-weight-black",style:{"font-size":"12px"}},wt=X(()=>r("br",null,null,-1)),Ct={style:{color:"#4e9194","margin-right":"10px","font-size":"14px"}},Vt=X(()=>r("br",null,null,-1)),kt={key:0,class:"my-2 d-inline-block",style:{color:"black","margin-right":"10px"}},St=X(()=>r("br",null,null,-1)),$t={style:{color:"black","margin-right":"10px"}},It={style:{"word-wrap":"break-word"}},Nt=X(()=>r("h1",null,"故事投票",-1)),F=1,jt={__name:"StoryItem",props:{category:String,title:String,mainAuthor:[String,Object],content:{type:Array,default:()=>[]},createdAt:String,extensions:{type:Array,default:()=>[]},_id:String,voteTime:[String,Number],voteStart:[String,Date],voteEnd:[String,Date],totalWordCount:{type:Number,required:!0},extendWordLimit:{type:Number,default:50},chapters:{type:Number,default:1},wordsPerChapter:{type:Number,default:100},currentChapterWordCount:{type:Number,default:0},chapterWordCount:{type:Number,default:0}},emits:["update"],setup(l,{emit:g}){var ge;const p=te(),i=te(),y=ce(),E=p.userId,v=g,{apiAuth:P}=ie(),C=V("");let k=0;const I=qe(),d=l,{category:B,title:f,mainAuthor:A,content:W,createdAt:S,_id:b}=d,D=N(()=>W&&W.length>0&&W[W.length-1].chapterName||"暫無章節名"),T=N(()=>{const s=d.wordsPerChapter-d.currentChapterWordCount;return s===0?d.extendWordLimit:s<d.extendWordLimit?s:d.extendWordLimit||50}),Ae=N(()=>[s=>s.length>=F&&s.length<=T.value||`內容字數需在 ${F} 至 ${T.value} 字之間`]),pe=N(()=>d.currentChapterWordCount>=d.wordsPerChapter),We=N(()=>{const s={newChapterContent:be().required("故事內容必填").min(F,`故事內容不能少於 ${F} 字`).max(T.value,`故事內容不能超過 ${T.value} 字`)};return pe.value&&(s.newChapterName=be().required("章節名稱必填").min(1).max(60)),et(s)}),{handleSubmit:Te,isSubmitting:fe,resetForm:Me}=tt({validationSchema:We,initialValues:{newChapterContent:"",newChapterName:""}}),me=we("newChapterName"),he=we("newChapterContent"),Z=V(!1),J=V(!1),H=V(d.content&&((ge=d.content[0])!=null&&ge.content)?d.content[0].content:[]),ze=N(()=>!H.value||!Array.isArray(H.value)?0:H.value.reduce((s,u)=>s+((u==null?void 0:u.length)||0),0)),Ee=N(()=>Math.max(0,d.totalWordCount-ze.value)),{extensions:x,voteEnd:le}=ke(d),Pe=()=>{Z.value=!Z.value},De=N(()=>Z.value?"mdi-heart":"mdi-heart-outline"),Le=()=>{i.isLogin?J.value=!0:y.push("/login")},ne=V(!1),Re=async()=>{var s,u,a;try{if(!x.value.length){console.log("沒有延續故事可供合併"),v("update");return}if(ne.value){v("update");return}if(ne.value=!0,!x.value.filter(L=>L.voteCount.length>0).length){console.log("所有延續故事的票數為 0，清空延續故事"),await P.patch(`/story/${b}/clearExtensions`),I({text:"所有延續故事的票數為 0，已清空延續故事",snackbarProps:{color:"red"}}),v("update");return}const M=x.value.reduce((L,O)=>O.voteCount.length>L.voteCount.length?O:L);if(!(M!=null&&M._id))throw new Error("延續故事未找到");await P.patch(`/story/${b}/merge`,{extensionsId:M._id}),I({text:"延續故事已成功合併到主故事中",snackbarProps:{color:"green"}}),console.log("即將觸發 emit update"),v("update"),console.log("已觸發 emit update")}catch(n){console.error("合併故事時發生錯誤",((s=n.response)==null?void 0:s.data)||n.message||n),I({text:((a=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:a.message)||"合併故事時發生錯誤",snackbarProps:{color:"red"}})}finally{ne.value=!1}},Be=async()=>{const s=Date.now(),a=new Date(le.value).getTime()-s;if(a<=0){clearInterval(k),C.value="",x.value.length>0&&await Re();return}const n=Math.floor(a/1e3),M=Math.floor(n/(24*3600)),L=Math.floor(n%(24*3600)/3600),O=Math.floor(n%3600/60),ye=n%60,q=[];M>0&&q.push(`${M} 天`),L>0&&q.push(`${L} 小時`),O>0&&q.push(`${O} 分`),ye>0&&q.push(`${ye} 秒`),C.value=q.join(" ")},_e=()=>{k=setInterval(()=>{Be()},1e3)};Se(()=>{le&&_e()});const Fe=Te(async s=>{var u,a;try{const n=x.value.length===0;await P.post(`/story/${b}`,{chapterName:s.newChapterName,content:s.newChapterContent,voteStart:n?new Date:void 0}),I({text:"延伸內容提交成功",snackbarProps:{color:"green"}}),Me(),J.value=!1,v("update")}catch(n){console.log(n),I({text:((a=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:a.message)||"發生錯誤",snackbarProps:{color:"red"}})}});$e(()=>{clearInterval(k)}),ve(()=>d.content,s=>{H.value=s[0].content}),ve(le,s=>{s&&_e()});const Ue=s=>{let u=!1,a=!1;for(const n of x.value)n.voteCount.indexOf(E)>-1&&(u=!0,n._id===s._id&&(a=!0));return{hasVoted:u,voteThis:a}};return(s,u)=>(c(),w(lt,{class:"customMb"},{default:t(()=>[e(ot,null,{default:t(()=>[e(st,null,{default:t(()=>[e(j,{"no-gutters":""},{default:t(()=>[e(m,{class:"d-flex align-center justify-center text--secondary",style:{"padding-right":"24px"},cols:"1"},{default:t(()=>[r("div",yt,h(o(B)),1)]),_:1}),e(m,{cols:"8",class:"text--secondary"},{default:t(()=>[r("span",vt,h(o(f)),1),xt,o(x)&&o(x).length>0?(c(),$("span",bt,"投票倒數計時：")):ee("",!0),wt,r("span",null,h(D.value),1)]),_:1}),e(m,{cols:"3",class:"text-right",style:{color:"#4e9194"}},{default:t(()=>{var a;return[r("span",Ct,h((a=o(A))==null?void 0:a.username),1),Vt,o(x)&&o(x).length>0?(c(),$("span",kt,h(C.value),1)):ee("",!0),St,r("span",$t,h(new Date(o(S)).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})),1)]}),_:1})]),_:1})]),_:1}),e(Ce,null,{default:t(()=>[e(j,{style:{padding:"12px"}},{default:t(()=>[e(m,{cols:"12",class:"mt-1 pa-0",style:{"font-size":"8px"}},{default:t(()=>[r("h1",null,h(o(W)[0].latestContent?"最新內容":"開始故事")+"( 剩餘字數："+h(Ee.value)+" ) ",1)]),_:1}),e(m,{cols:"12"},{default:t(()=>[e(j,null,{default:t(()=>[e(m,{cols:"1",class:"d-flex align-center justify-center pa-0"},{default:t(()=>[e(z,{text:"",ripple:!1,variant:"text",class:Ge(["heart-button pa-0",{filled:Z.value}]),onClick:Pe},{default:t(()=>[e(ae,null,{default:t(()=>[_(h(De.value),1)]),_:1})]),_:1},8,["class"])]),_:1}),e(m,{cols:"11",class:"pl-0"},{default:t(()=>[r("p",It,h(H.value.join("")),1),e(re,null,{default:t(()=>[e(Ye),e(z,{color:"secondary",variant:"outlined",onClick:Le},{default:t(()=>[_(" 延續故事 ")]),_:1})]),_:1}),e(Qe,{modelValue:J.value,"onUpdate:modelValue":u[3]||(u[3]=a=>J.value=a),"max-width":"500"},{default:t(()=>[e(nt,{onSubmit:Xe(o(Fe),["prevent"]),disabled:o(fe)},{default:t(()=>[e(se,null,{default:t(()=>[e(oe,{class:"text-center",style:{"background-color":"#97d8c4"}},{default:t(()=>[_("延續故事")]),_:1}),e(Q,{class:"py-4 pb-0"},{default:t(()=>[pe.value?(c(),w(xe,{key:0,modelValue:o(me).value.value,"onUpdate:modelValue":u[0]||(u[0]=a=>o(me).value.value=a),class:"mb-4",label:"輸入章節名稱","hide-details":"",minlength:1,maxlength:60},null,8,["modelValue"])):(c(),w(xe,{key:1,modelValue:D.value,"onUpdate:modelValue":u[1]||(u[1]=a=>D.value=a),class:"mb-4",label:"當前章節名稱","hide-details":"",disabled:""},null,8,["modelValue"])),e(rt,{modelValue:o(he).value.value,"onUpdate:modelValue":u[2]||(u[2]=a=>o(he).value.value=a),label:`故事內容（字數：${F} - ${T.value} 字）`,rows:"10",minlength:F,maxlength:T.value,counter:"",rules:Ae.value,style:{"margin-bottom":"8px"}},null,8,["modelValue","label","maxlength","rules"])]),_:1}),e(re,{class:"justify-center align-start py-0"},{default:t(()=>[e(z,{style:{"background-color":"#4e9194",color:"#000000"},type:"submit",loading:o(fe)},{default:t(()=>[_("發布")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit","disabled"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o(x)&&o(x).length>0?(c(),w(Ce,{key:0},{default:t(()=>[e(m,{cols:"12",class:"mt-1 mb-3 pa-0",style:{"font-size":"8px"}},{default:t(()=>[Nt]),_:1}),(c(!0),$(R,null,U(o(x).slice(0,5),(a,n)=>(c(),w(gt,{key:n,storyId:o(b),extensionId:a._id,content:a.content,chapterName:a.chapterName,author:a.author,voteCount:a.voteCount,voteStatus:Ue(a)},null,8,["storyId","extensionId","content","chapterName","author","voteCount","voteStatus"]))),128))]),_:1})):ee("",!0)]),_:1})]),_:1}))}},At=de(jt,[["__scopeId","data-v-78af92b9"]]),Wt={class:"pa-0 px-4"},Tt=r("h2",null,"追蹤故事",-1),Mt=r("h2",null,"熱門故事",-1),zt=r("h2",null,"最新故事",-1),Et=r("h2",null,"完結故事",-1),Pt={key:1,class:""},Dt=r("h2",null,"創作資源區",-1),Jt={__name:"index",setup(l){const g=te(),{api:p}=ie(),i=V([]),y=ce(),E=()=>{g.isLogin?y.push("/createStory"):y.push("/login")},v=V([]),P=V([]),C=V([]),k=async()=>{try{const{data:d}=await p.get("/story");i.value=d.result.data;const B=await p.get("/story/getPopularStories");v.value=B.data.result.data;const f=await p.get("/story/getNewestStories");P.value=f.data.result.data;const A=await p.get("/story/getCompletedStories");C.value=A.data.result.data}catch(d){console.error("Failed to load stories:",d)}},I=[{to:"/articleArea",icon:"mdi-lightbulb-on-outline",title:"創作指引",color:"#F9A825"}];return Se(()=>{k(),ue.on("updateStory",k)}),$e(()=>{ue.off("updateStory",k)}),(d,B)=>(c(),$(R,null,[e(j,null,{default:t(()=>[e(m,{cols:"12"},{default:t(()=>[e(se,{class:"rounded-0 px-10 py-auto",height:"200px",color:"surface-variant",image:"https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=2948&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",cover:"",elevation:"5"},{default:t(()=>[e(m,null,{default:t(()=>[e(oe,{class:"text-h4 font-weight-bold"},{default:t(()=>[_(" 歡迎來到界筆！ ")]),_:1}),e(Q,{class:"font-weight-bold pa-0 py-2 px-4 mb-2",style:{"font-size":"24px","letter-spacing":"12px"}},{default:t(()=>[_(" 探索和創作無限可能的故事 ")]),_:1}),r("div",Wt,[e(z,{class:"font-weight-black mr-3 px-4",variant:"elevated",color:"#CCB78E",onClick:E,to:"/createStory"},{default:t(()=>[_(" 立即創作 ")]),_:1}),e(z,{class:"font-weight-black px-4",outlined:"",border:"",variant:"elevated",style:{color:"#ccb78e",border:"1px solid #ccb78e","background-color":"rgba(0, 0, 0, 0.47)"},to:"/category"},{default:t(()=>[_(" 探索故事 ")]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1}),o(g).isLogin?(c(),w(G,{key:0,style:{padding:"32px"}},{default:t(()=>[e(j,{class:"justify-space-between"},{default:t(()=>[e(m,{cols:"12",class:"pb-0"},{default:t(()=>[Tt]),_:1}),e(Y,{class:"mb-3"}),e(m,{cols:"12",class:"d-flex flex-column justify-space-between"},{default:t(()=>[(c(!0),$(R,null,U(i.value,f=>(c(),w(At,K({key:f._id,ref_for:!0},f,{onUpdate:k}),null,16))),128))]),_:1})]),_:1})]),_:1})):ee("",!0),e(G,{style:{padding:"32px"}},{default:t(()=>[e(j,{class:"justify-space-between"},{default:t(()=>[e(m,{cols:"12",class:"pb-0"},{default:t(()=>[Mt]),_:1}),e(Y,{class:"mb-3"}),e(m,{cols:"12",class:"d-flex flex-row justify-start"},{default:t(()=>[(c(!0),$(R,null,U(v.value,f=>(c(),w(Ve,K({key:f._id,ref_for:!0},f),null,16))),128))]),_:1})]),_:1})]),_:1}),e(G,{style:{padding:"32px"}},{default:t(()=>[e(j,{class:"justify-space-between"},{default:t(()=>[e(m,{cols:"12",class:"pb-0"},{default:t(()=>[zt]),_:1}),e(Y,{class:"mb-3"}),e(m,{cols:"12",class:"d-flex flex-column justify-space-between"})]),_:1})]),_:1}),e(G,{style:{padding:"32px"}},{default:t(()=>[e(j,{class:"justify-space-between"},{default:t(()=>[e(m,{cols:"12",class:"pb-0"},{default:t(()=>[Et]),_:1}),e(Y,{class:"mb-3"}),e(m,{cols:"12",class:"d-flex flex-row justify-space-between"},{default:t(()=>[C.value.length>0?(c(!0),$(R,{key:0},U(C.value,f=>(c(),w(Ve,K({key:f._id,ref_for:!0},f),null,16))),128)):(c(),$("div",Pt,"尚未有已完結故事"))]),_:1})]),_:1})]),_:1}),e(G,{style:{padding:"32px"}},{default:t(()=>[e(j,{class:"justify-space-between"},{default:t(()=>[e(m,{cols:"12",class:"pb-0"},{default:t(()=>[Dt]),_:1}),e(Y,{class:"mb-3"}),e(m,{cols:"12",class:"d-flex flex-row justify-space-between py-0"},{default:t(()=>[e(Ie,{class:"d-flex justify-space-between w-100 py-0",style:{"background-color":"transparent"}},{default:t(()=>[(c(),$(R,null,U(I,(f,A)=>e(Ne,{key:A,to:f.to,link:""},{prepend:t(()=>[e(ae,{size:"80",color:f.color},{default:t(()=>[_(h(f.icon),1)]),_:2},1032,["color"])]),default:t(()=>[e(je,{style:{"font-size":"20px","font-weight":"bold"},textContent:h(f.title)},null,8,["textContent"])]),_:2},1032,["to"])),64))]),_:1})]),_:1})]),_:1})]),_:1})],64))}};export{Jt as default};
