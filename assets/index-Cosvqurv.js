import{a2 as Be,O as Pe,P as i,Q as y,R as t,c as e,V as Re,a0 as l,a3 as X,T as f,Y as p,a4 as H,a5 as Z,M as le,x as V,a6 as ge,o as ae,$ as a,Z as Q,S as z,G as L,U as k,W as N,X as A,a7 as se,a8 as ne,N as Fe,A as xe,a9 as ve,z as Ue,aa as Y,ab as Le,_ as He,ac as Oe,ad as We,ae as qe,af as Ge,ag as Ye}from"./index-DwNFzC7S.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as Qe}from"./VChip-Cvg0Fcbk.js";import{c as Xe,a as pe,u as Ze,b as fe}from"./vee-validate.esm-C13Q_be1.js";import{V as Je}from"./VMenu-xaLXyozX.js";import{V as ye,a as be,b as we}from"./VList-CP1f_8yp.js";import{V as Ke,a as et,b as me,c as tt}from"./VExpansionPanels-B6sKH79_.js";import{V as C,a as u}from"./VRow-NdwgLj6x.js";import{V as at}from"./VForm-DjsAhpZd.js";import{V as st}from"./VTextarea-DRNRZ96f.js";import{V as B}from"./VContainer-LkvkJRsm.js";import{V as P}from"./VDivider-DBwq-x9k.js";import"./VSlideGroup-BbUVG1IY.js";const ot={class:"d-flex justify-space-between align-center"},lt={__name:"BookCard",props:["_id","image","title","category","mainAuthor","content"],setup(o){const m=Be(),_=n=>{m.push(n)};return(n,d)=>{const $=Pe("router-link");return i(),y(Z,{class:"pa-3 customMargin",width:"220"},{default:t(()=>[e($,{to:"/stories/"+o._id},{default:t(()=>[e(Re,{class:"cursor-pointer",height:"150px",src:o.image,cover:""},null,8,["src"])]),_:1},8,["to"]),l("div",ot,[e(X,{class:"px-0 py-1 text-subtitle-1 cursor-pointer",onClick:d[0]||(d[0]=x=>_("/123"))},{default:t(()=>[f(p(o.title),1)]),_:1}),e(Qe,{density:"compact",color:"primary",label:"",style:{"font-size":"12px",padding:"2px 6px"}},{default:t(()=>[f(p(o.category),1)]),_:1})]),e(H,{class:"pa-0 cursor-pointer",style:{"font-size":"12px",color:"#4e9194"},onClick:d[1]||(d[1]=x=>_("/1234"))},{default:t(()=>{var x;return[f(p((x=o.mainAuthor)==null?void 0:x.username),1)]}),_:1}),e(H,{class:"pa-0"},{default:t(()=>[f(p(o.content[0].content[0]),1)]),_:1})]),_:1})}}},_e=re(lt,[["__scopeId","data-v-f2bd186d"]]);function nt(o){return{all:o=o||new Map,on:function(m,_){var n=o.get(m);n?n.push(_):o.set(m,[_])},off:function(m,_){var n=o.get(m);n&&(_?n.splice(n.indexOf(_)>>>0,1):o.set(m,[]))},emit:function(m,_){var n=o.get(m);n&&n.slice().map(function(d){d(_)}),(n=o.get("*"))&&n.slice().map(function(d){d(m,_)})}}}const oe=nt(),rt={class:"title-row"},ct={class:"title-text"},ut={class:"card-title my-1"},it={class:"vote-section"},dt={class:"vote-count text-body-2"},pt={__name:"VoteItem",props:["content","chapterName","author","voteCount","storyId","extensionId","voteStatus"],setup(o){const{apiAuth:m}=ne(),_=le(),n=V([{title:"檢舉"},{title:"刪除"}]),d=V(!1),$=o,{content:x,author:M,voteStatus:r,voteCount:I,storyId:S,extensionId:j}=ge($),J=_.userId,W=ae(()=>I.value.includes(J)),R=async q=>{try{(await m.patch(`/story/${S.value}/${j.value}`,{voteCountChange:q})).data.hasVotedInOtherExtension||(d.value=!0),oe.emit("updateStory")}catch(v){console.log(v),console.error("Error updating vote count:",v)}};return(q,v)=>(i(),y(Z,{class:"w-100 px-6 py-2 rounded-lg",style:{border:"1px solid #48a9a6",margin:"16px 0px"}},{default:t(()=>[e(X,{class:"pa-0"},{default:t(()=>{var b;return[l("div",rt,[l("div",ct,[l("h1",ut,p((b=a(M))==null?void 0:b.username),1)]),l("div",it,[e(Q,{class:"vote-icon",size:"20"},{default:t(()=>[f("mdi-vote")]),_:1}),l("span",dt,p(o.voteCount.length),1),e(Je,{location:"end"},{activator:t(({props:T})=>[e(z,L({icon:""},T,{class:"menu-btn",style:{width:"30px",height:"30px",padding:"auto"},variant:"plain"}),{default:t(()=>[e(Q,{size:"20"},{default:t(()=>[f("mdi-dots-vertical")]),_:1})]),_:2},1040)]),default:t(()=>[e(ye,{class:"pa-0"},{default:t(()=>[(i(!0),k(N,null,A(n.value,(T,E)=>(i(),y(be,{key:E,class:""},{default:t(()=>[e(we,null,{default:t(()=>[f(p(T.title),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])])]}),_:1}),e(H,{class:"pa-0 mx-7 py-1"},{default:t(()=>{var b;return[f(p((b=a(x))==null?void 0:b[0].latestContent),1)]}),_:1}),e(se,{class:"d-flex justify-end"},{default:t(()=>[e(z,{disabled:a(W)||a(r).hasVoted,style:{"background-color":"#f24e1e",color:"white"},onClick:v[0]||(v[0]=b=>R(1))},{default:t(()=>[f("投票")]),_:1},8,["disabled"]),e(z,{disabled:!a(W)||a(r).hasVoted&&!a(r).voteThis,style:{"background-color":"#f4b942",color:"black","margin-right":"24px"},onClick:v[1]||(v[1]=b=>R(-1))},{default:t(()=>[f("取消")]),_:1},8,["disabled"])]),_:1})]),_:1}))}},ft=re(pt,[["__scopeId","data-v-e3cc8cd3"]]),O=o=>(Ge("data-v-f8a4a888"),o=o(),Ye(),o),mt={class:"text--muted"},_t={class:"font-weight-black",style:{"font-size":"16px","margin-right":"4px"}},ht=O(()=>l("br",null,null,-1)),gt={key:0,class:"text--danger my-2 d-inline-block font-weight-black",style:{"font-size":"12px"}},xt=O(()=>l("br",null,null,-1)),vt={style:{color:"#4e9194","margin-right":"10px","font-size":"14px"}},yt=O(()=>l("br",null,null,-1)),bt={key:0,class:"my-2 d-inline-block",style:{color:"black","margin-right":"10px"}},wt=O(()=>l("br",null,null,-1)),Vt={style:{color:"black","margin-right":"10px"}},Ct={style:{"word-wrap":"break-word"}},kt=O(()=>l("h1",null,"故事投票",-1)),$t={__name:"StoryItem",props:["category","title","chapterName","mainAuthor","content","createdAt","extensions","_id","voteTime","voteStart","voteEnd"],emits:["update"],setup(o,{emit:m}){const n=le().userId,d=m,{apiAuth:$,api:x}=ne(),M=V("");let r=0;const I=Fe(),S=V(10),j=V(50),J=Xe({newChapterName:pe().required("章節名稱必填").min(1).max(60),newChapterContent:pe().required("故事內容必填").min(S.value,`故事內容不能少於 ${S.value} 字`).max(j.value,`故事內容不能超過 ${j.value} 字`)}),{handleSubmit:W,isSubmitting:R,resetForm:q}=Ze({validationSchema:J,initialValues:{newChapterContent:""}}),v=fe("newChapterName"),b=fe("newChapterContent"),T=V(!1),E=V(!1),K=o,{category:Ve,title:Ce,chapterName:ke,mainAuthor:$e,content:ee,createdAt:Ie,_id:G}=K,ce=V(ee?ee[0].content:[]),{extensions:w,voteEnd:ue}=ge(K),Se=()=>{T.value=!T.value},je=ae(()=>T.value?"mdi-heart":"mdi-heart-outline"),Te=()=>{E.value=!0},Ne=ae(()=>[g=>g.length>=S.value&&g.length<=j.value||`內容字數需在 ${S.value} 至 ${j.value} 字之間`]),te=V(!1),ze=async()=>{var g,h,s;if(w.value.length===0){console.log("沒有延續故事可供合併");return}if(!te.value){te.value=!0;try{const c=w.value.reduce((D,F)=>F.voteCount.length>D.voteCount.length?F:D);await $.patch(`/story/${G}/merge`,{extensionsId:c._id}),I({text:"延續故事已成功合併到主故事中",snackbarProps:{color:"green"}}),console.log("即將觸發 emit update"),d("update"),console.log("已觸發 emit update")}catch(c){console.error("合併故事時發生錯誤",((g=c.response)==null?void 0:g.data)||c.message||c),I({text:((s=(h=c==null?void 0:c.response)==null?void 0:h.data)==null?void 0:s.message)||"合併故事時發生錯誤",snackbarProps:{color:"red"}}),te.value=!1}}},Ae=async()=>{const g=Date.now(),s=new Date(ue.value).getTime()-g;if(s<=0){clearInterval(r),M.value="投票已結束",await ze();return}const c=Math.floor(s/1e3),D=Math.floor(c/(24*3600)),F=Math.floor(c%(24*3600)/3600),ie=Math.floor(c%3600/60),de=c%60,U=[];D>0&&U.push(`${D} 天`),F>0&&U.push(`${F} 小時`),ie>0&&U.push(`${ie} 分`),de>0&&U.push(`${de} 秒`),M.value=U.join(" ")},Me=()=>{r=setInterval(()=>{Ae()},1e3)};xe(()=>{ue&&Me()});const Ee=W(async g=>{var h,s;try{console.log(G),await $.post(`/story/${G}`,{chapterName:g.newChapterName,content:g.newChapterContent}),I({text:"延伸內容提交成功",snackbarProps:{color:"green"}}),q(),E.value=!1,d("update")}catch(c){console.log(c),I({text:((s=(h=c==null?void 0:c.response)==null?void 0:h.data)==null?void 0:s.message)||"發生錯誤",snackbarProps:{color:"red"}})}});ve(()=>{clearInterval(r)}),Ue(()=>K.content,g=>{ce.value=g[0].content});const De=g=>{let h=!1,s=!1;for(const c of w.value)c.voteCount.indexOf(n)>-1&&(h=!0,c._id===g._id&&(s=!0));return{hasVoted:h,voteThis:s}};return(g,h)=>(i(),y(tt,{class:"customMb"},{default:t(()=>[e(Ke,null,{default:t(()=>[e(et,null,{default:t(()=>[e(C,{"no-gutters":""},{default:t(()=>[e(u,{class:"d-flex align-center justify-center text--secondary",style:{"padding-right":"24px"},cols:"1"},{default:t(()=>[l("div",mt,p(a(Ve)),1)]),_:1}),e(u,{cols:"8",class:"text--secondary"},{default:t(()=>[l("span",_t,p(a(Ce)),1),ht,a(w)&&a(w).length>0?(i(),k("span",gt,"投票倒數計時：")):Y("",!0),xt,l("span",null,p(a(ke)),1)]),_:1}),e(u,{cols:"3",class:"text-right",style:{color:"#4e9194"}},{default:t(()=>{var s;return[l("span",vt,p((s=a($e))==null?void 0:s.username),1),yt,a(w)&&a(w).length>0?(i(),k("span",bt,p(M.value),1)):Y("",!0),wt,l("span",Vt,p(new Date(a(Ie)).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})),1)]}),_:1})]),_:1})]),_:1}),e(me,null,{default:t(()=>[e(C,{style:{padding:"12px"}},{default:t(()=>[e(u,{cols:"12",class:"mt-1 pa-0",style:{"font-size":"8px"}},{default:t(()=>[l("h1",null,p(a(ee)[0].latestContent?"最新內容":"開始故事"),1)]),_:1}),e(u,{cols:"12"},{default:t(()=>[e(C,null,{default:t(()=>[e(u,{cols:"1",class:"d-flex align-center justify-center pa-0"},{default:t(()=>[e(z,{text:"",ripple:!1,variant:"text",class:Le(["heart-button pa-0",{filled:T.value}]),onClick:Se},{default:t(()=>[e(Q,null,{default:t(()=>[f(p(je.value),1)]),_:1})]),_:1},8,["class"])]),_:1}),e(u,{cols:"11",class:"pl-0"},{default:t(()=>[l("p",Ct,p(ce.value.join("")),1),e(se,null,{default:t(()=>[e(He),e(z,{color:"secondary",variant:"outlined",onClick:Te},{default:t(()=>[f(" 延續故事 ")]),_:1})]),_:1}),e(Oe,{modelValue:E.value,"onUpdate:modelValue":h[2]||(h[2]=s=>E.value=s),"max-width":"500"},{default:t(()=>[e(at,{onSubmit:We(a(Ee),["prevent"]),disabled:a(R)},{default:t(()=>[e(Z,null,{default:t(()=>[e(X,{class:"text-center",style:{"background-color":"#97d8c4"}},{default:t(()=>[f("延續故事")]),_:1}),e(H,{class:"py-4 pb-0"},{default:t(()=>[e(qe,{modelValue:a(v).value.value,"onUpdate:modelValue":h[0]||(h[0]=s=>a(v).value.value=s),class:"mb-4",label:"輸入章節名稱","hide-details":"",minlength:1,maxlength:60},null,8,["modelValue"]),e(st,{modelValue:a(b).value.value,"onUpdate:modelValue":h[1]||(h[1]=s=>a(b).value.value=s),label:`故事內容（字數：${S.value} - ${j.value} 字`,rows:"10",minlength:`${S.value}`,maxlength:`${j.value}`,counter:"",rules:Ne.value,style:{"margin-bottom":"8px"}},null,8,["modelValue","label","minlength","maxlength","rules"])]),_:1}),e(se,{class:"justify-center align-start py-0"},{default:t(()=>[e(z,{style:{"background-color":"#4e9194",color:"#000000"},type:"submit",loading:a(R)},{default:t(()=>[f("發布")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit","disabled"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(w)&&a(w).length>0?(i(),y(me,{key:0},{default:t(()=>[e(u,{cols:"12",class:"mt-1 mb-3 pa-0",style:{"font-size":"8px"}},{default:t(()=>[kt]),_:1}),(i(!0),k(N,null,A(a(w).slice(0,5),(s,c)=>(i(),y(ft,{key:c,storyId:a(G),extensionId:s._id,content:s.content,chapterName:s.chapterName,author:s.author,voteCount:s.voteCount,voteStatus:De(s)},null,8,["storyId","extensionId","content","chapterName","author","voteCount","voteStatus"]))),128))]),_:1})):Y("",!0)]),_:1})]),_:1}))}},he=re($t,[["__scopeId","data-v-f8a4a888"]]),It={class:"pa-0 px-4"},St=l("h2",null,"追蹤故事",-1),jt=l("h2",null,"熱門故事",-1),Tt=l("h2",null,"最新故事",-1),Nt=l("h2",null,"所有故事",-1),zt=l("h2",null,"完結故事",-1),At=l("h2",null,"創作資源區",-1),Gt={__name:"index",setup(o){const m=le(),{api:_}=ne(),n=V([]),d=async()=>{try{const{data:x}=await _.get("/story");n.value=x.result.data}catch(x){console.log("Error loading stories:",x)}},$=[{to:"/articleArea",icon:"mdi-lightbulb-on-outline",title:"創作指引",color:"#F9A825"}];return xe(()=>{d(),oe.on("updateStory",d)}),ve(()=>{oe.off("updateStory",d)}),(x,M)=>(i(),k(N,null,[e(C,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[e(Z,{class:"rounded-0 px-10 py-auto",height:"200px",color:"surface-variant",image:"https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=2948&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",cover:"",elevation:"5"},{default:t(()=>[e(u,null,{default:t(()=>[e(X,{class:"text-h4 font-weight-bold"},{default:t(()=>[f(" 歡迎來到界筆！ ")]),_:1}),e(H,{class:"font-weight-bold pa-0 py-2 px-4 mb-2",style:{"font-size":"24px","letter-spacing":"12px"}},{default:t(()=>[f(" 探索和創作無限可能的故事 ")]),_:1}),l("div",It,[e(z,{class:"font-weight-black mr-3 px-4",variant:"elevated",color:"#CCB78E",to:"/createStory"},{default:t(()=>[f(" 立即創作 ")]),_:1}),e(z,{class:"font-weight-black px-4",outlined:"",border:"",variant:"elevated",style:{color:"#ccb78e",border:"1px solid #ccb78e","background-color":"rgba(0, 0, 0, 0.47)"},to:"/category"},{default:t(()=>[f(" 探索故事 ")]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1}),a(m).isLogin?(i(),y(B,{key:0,style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(u,{cols:"12",class:"pb-0"},{default:t(()=>[St]),_:1}),e(P,{class:"mb-3"}),e(u,{cols:"12",class:"d-flex flex-column justify-space-between"},{default:t(()=>[(i(!0),k(N,null,A(n.value,r=>(i(),y(he,L({key:r._id,ref_for:!0},r,{onUpdate:d}),null,16))),128))]),_:1})]),_:1})]),_:1})):Y("",!0),e(B,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(u,{cols:"12",class:"pb-0"},{default:t(()=>[jt]),_:1}),e(P,{class:"mb-3"}),e(u,{cols:"12",class:"d-flex flex-row justify-start"},{default:t(()=>[(i(!0),k(N,null,A(n.value,r=>(i(),y(_e,L({key:r._id,ref_for:!0},r),null,16))),128))]),_:1})]),_:1})]),_:1}),e(B,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(u,{cols:"12",class:"pb-0"},{default:t(()=>[Tt]),_:1}),e(P,{class:"mb-3"}),e(u,{cols:"12",class:"d-flex flex-column justify-space-between"})]),_:1})]),_:1}),e(B,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(u,{cols:"12",class:"pb-0"},{default:t(()=>[Nt]),_:1}),e(P,{class:"mb-3"}),e(u,{cols:"12",class:"d-flex flex-column justify-space-between"},{default:t(()=>[(i(!0),k(N,null,A(n.value,r=>(i(),y(he,L({key:r._id,ref_for:!0},r,{onUpdate:d}),null,16))),128))]),_:1})]),_:1})]),_:1}),e(B,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(u,{cols:"12",class:"pb-0"},{default:t(()=>[zt]),_:1}),e(P,{class:"mb-3"}),e(u,{cols:"12",class:"d-flex flex-row justify-space-between"},{default:t(()=>[(i(!0),k(N,null,A(n.value,r=>(i(),y(_e,L({key:r._id,ref_for:!0},r),null,16))),128))]),_:1})]),_:1})]),_:1}),e(B,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(u,{cols:"12",class:"pb-0"},{default:t(()=>[At]),_:1}),e(P,{class:"mb-3"}),e(u,{cols:"12",class:"d-flex flex-row justify-space-between py-0"},{default:t(()=>[e(ye,{class:"d-flex justify-space-between w-100 py-0",style:{"background-color":"transparent"}},{default:t(()=>[(i(),k(N,null,A($,(r,I)=>e(be,{key:I,to:r.to,link:""},{prepend:t(()=>[e(Q,{size:"80",color:r.color},{default:t(()=>[f(p(r.icon),1)]),_:2},1032,["color"])]),default:t(()=>[e(we,{style:{"font-size":"20px","font-weight":"bold"},textContent:p(r.title)},null,8,["textContent"])]),_:2},1032,["to"])),64))]),_:1})]),_:1})]),_:1})]),_:1})],64))}};export{Gt as default};
