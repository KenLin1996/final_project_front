import{a2 as Ee,O as De,P as f,Q as $,R as t,c as e,V as Be,a0 as l,a3 as Q,T as p,Y as d,a4 as L,a5 as X,M as me,x as b,a6 as _e,o as te,$ as a,Z as Y,S as N,G,U as k,W as z,X as E,a7 as ae,a8 as oe,N as Pe,A as he,a9 as ge,z as Fe,aa as ee,ab as Re,_ as Ue,ac as He,ad as Le,ae as Oe,af as We,ag as qe}from"./index-DD0n4Y1p.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as Ge}from"./VChip-Cuny5U12.js";import{c as Ye,a as ie,u as Qe,b as de}from"./vee-validate.esm-B0uHUVkw.js";import{V as Xe}from"./VMenu-Bp1xq1a6.js";import{V as xe,a as ve,b as ye}from"./VList-B1QvTxCY.js";import{V as Ze,a as Je,b as pe,c as Ke}from"./VExpansionPanels-Dk7Mct8P.js";import{V as C,a as c}from"./VRow-DBFeogUv.js";import{V as et}from"./VForm-BrjssPg3.js";import{V as tt}from"./VTextarea-CVEJUcUg.js";import{V as U}from"./VContainer-BKtJ0g-q.js";import{V as H}from"./VDivider-D6tPN2Jl.js";import"./VSlideGroup-CvBS00D8.js";const at={class:"d-flex justify-space-between align-center"},st={__name:"BookCard",props:["_id","image","title","category","mainAuthor","content"],setup(o){const m=Ee(),u=n=>{m.push(n)};return(n,h)=>{const y=De("router-link");return f(),$(X,{class:"pa-3 customMargin",width:"220"},{default:t(()=>[e(y,{to:"/stories/"+o._id},{default:t(()=>[e(Be,{class:"cursor-pointer",height:"150px",src:o.image,cover:""},null,8,["src"])]),_:1},8,["to"]),l("div",at,[e(Q,{class:"px-0 py-1 text-subtitle-1 cursor-pointer",onClick:h[0]||(h[0]=I=>u("/123"))},{default:t(()=>[p(d(o.title),1)]),_:1}),e(Ge,{density:"compact",color:"primary",label:"",style:{"font-size":"12px",padding:"2px 6px"}},{default:t(()=>[p(d(o.category),1)]),_:1})]),e(L,{class:"pa-0 cursor-pointer",style:{"font-size":"12px",color:"#4e9194"},onClick:h[1]||(h[1]=I=>u("/1234"))},{default:t(()=>{var I;return[p(d((I=o.mainAuthor)==null?void 0:I.username),1)]}),_:1}),e(L,{class:"pa-0"},{default:t(()=>[p(d(o.content[0].content[0]),1)]),_:1})]),_:1})}}},fe=le(st,[["__scopeId","data-v-f2bd186d"]]);function ot(o){return{all:o=o||new Map,on:function(m,u){var n=o.get(m);n?n.push(u):o.set(m,[u])},off:function(m,u){var n=o.get(m);n&&(u?n.splice(n.indexOf(u)>>>0,1):o.set(m,[]))},emit:function(m,u){var n=o.get(m);n&&n.slice().map(function(h){h(u)}),(n=o.get("*"))&&n.slice().map(function(h){h(m,u)})}}}const se=ot(),lt={class:"title-row"},nt={class:"title-text"},rt={class:"card-title my-1"},ct={class:"vote-section"},ut={class:"vote-count text-body-2"},it={__name:"VoteItem",props:["content","chapterName","author","voteCount","storyId","extensionId","voteStatus"],setup(o){const{apiAuth:m}=oe(),u=me(),n=b([{title:"檢舉"},{title:"刪除"}]),h=b(!1),y=o,{content:I,author:i,voteStatus:V,voteCount:A,storyId:S,extensionId:j}=_e(y),Z=u.userId,W=te(()=>A.value.includes(Z)),D=async B=>{try{const x=await m.patch(`/story/${S.value}/${j.value}`,{voteCountChange:B});console.log(x.data.message),x.data.hasVotedInOtherExtension||(h.value=!0),se.emit("updateStory")}catch(x){console.log(x),console.error("Error updating vote count:",x)}};return(B,x)=>(f(),$(X,{class:"w-100 px-6 py-2 rounded-lg",style:{border:"1px solid #48a9a6",margin:"16px 0px"}},{default:t(()=>[e(Q,{class:"pa-0"},{default:t(()=>{var v;return[l("div",lt,[l("div",nt,[l("h1",rt,d((v=a(i))==null?void 0:v.username),1)]),l("div",ct,[e(Y,{class:"vote-icon",size:"20"},{default:t(()=>[p("mdi-vote")]),_:1}),l("span",ut,d(o.voteCount.length),1),e(Xe,{location:"end"},{activator:t(({props:T})=>[e(N,G({icon:""},T,{class:"menu-btn",style:{width:"30px",height:"30px",padding:"auto"},variant:"plain"}),{default:t(()=>[e(Y,{size:"20"},{default:t(()=>[p("mdi-dots-vertical")]),_:1})]),_:2},1040)]),default:t(()=>[e(xe,{class:"pa-0"},{default:t(()=>[(f(!0),k(z,null,E(n.value,(T,P)=>(f(),$(ve,{key:P,class:""},{default:t(()=>[e(ye,null,{default:t(()=>[p(d(T.title),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])])]}),_:1}),e(L,{class:"pa-0 mx-7 py-1"},{default:t(()=>{var v;return[p(d((v=a(I))==null?void 0:v[0].latestContent),1)]}),_:1}),e(ae,{class:"d-flex justify-end"},{default:t(()=>[e(N,{disabled:a(W)||a(V).hasVoted,style:{"background-color":"#f24e1e",color:"white"},onClick:x[0]||(x[0]=v=>D(1))},{default:t(()=>[p("投票")]),_:1},8,["disabled"]),e(N,{disabled:!a(W)||a(V).hasVoted&&!a(V).voteThis,style:{"background-color":"#f4b942",color:"black","margin-right":"24px"},onClick:x[1]||(x[1]=v=>D(-1))},{default:t(()=>[p("取消")]),_:1},8,["disabled"])]),_:1})]),_:1}))}},dt=le(it,[["__scopeId","data-v-fc0b05bb"]]),O=o=>(We("data-v-89d7747f"),o=o(),qe(),o),pt={class:"text--muted"},ft={class:"font-weight-black",style:{"font-size":"16px","margin-right":"4px"}},mt=O(()=>l("br",null,null,-1)),_t={key:0,class:"text--danger my-2 d-inline-block font-weight-black",style:{"font-size":"12px"}},ht=O(()=>l("br",null,null,-1)),gt={style:{color:"#4e9194","margin-right":"10px","font-size":"14px"}},xt=O(()=>l("br",null,null,-1)),vt={key:0,class:"my-2 d-inline-block",style:{color:"black","margin-right":"10px"}},yt=O(()=>l("br",null,null,-1)),bt={style:{color:"black","margin-right":"10px"}},Vt={style:{"word-wrap":"break-word"}},wt=O(()=>l("h1",null,"故事投票",-1)),Ct={__name:"StoryItem",props:["category","title","chapterName","mainAuthor","content","createdAt","extensions","_id","voteTime","voteStart","voteEnd"],emits:["update"],setup(o,{emit:m}){const n=me().userId,h=m,{apiAuth:y,api:I}=oe(),i=b("");let V=0;const A=Pe(),S=b(10),j=b(50),Z=Ye({newChapterName:ie().required("章節名稱必填").min(1).max(60),newChapterContent:ie().required("故事內容必填").min(S.value,`故事內容不能少於 ${S.value} 字`).max(j.value,`故事內容不能超過 ${j.value} 字`)}),{handleSubmit:W,isSubmitting:D}=Qe({validationSchema:Z,initialValues:{newChapterContent:""}}),B=de("newChapterName"),x=de("newChapterContent"),v=b(!1),T=b(!1),P=o,{category:be,title:Ve,chapterName:we,mainAuthor:Ce,content:J,createdAt:ke,_id:q}=P,ne=b(J?J[0].content:[]),{extensions:w,voteEnd:re}=_e(P),$e=()=>{v.value=!v.value},Ie=te(()=>v.value?"mdi-heart":"mdi-heart-outline"),Se=()=>{T.value=!0},je=te(()=>[g=>g.length>=S.value&&g.length<=j.value||`內容字數需在 ${S.value} 至 ${j.value} 字之間`]),K=b(!1),Te=async()=>{var g,_,s;if(!K.value){K.value=!0;try{const r=w.value.reduce((M,F)=>F.voteCount.length>M.voteCount.length?F:M);await y.patch(`/story/${q}/merge`,{extensionsId:r._id}),A({text:"延續故事已成功合併到主故事中",snackbarProps:{color:"green"}}),console.log("即將觸發 emit update"),h("update"),console.log("已觸發 emit update")}catch(r){console.error("合併故事時發生錯誤",((g=r.response)==null?void 0:g.data)||r.message||r),A({text:((s=(_=r==null?void 0:r.response)==null?void 0:_.data)==null?void 0:s.message)||"合併故事時發生錯誤",snackbarProps:{color:"red"}}),K.value=!1}}},Ne=async()=>{const g=Date.now(),s=new Date(re.value).getTime()-g;if(s<=0){clearInterval(V),i.value="投票已結束",await Te();return}const r=Math.floor(s/1e3),M=Math.floor(r/(24*3600)),F=Math.floor(r%(24*3600)/3600),ce=Math.floor(r%3600/60),ue=r%60,R=[];M>0&&R.push(`${M} 天`),F>0&&R.push(`${F} 小時`),ce>0&&R.push(`${ce} 分`),ue>0&&R.push(`${ue} 秒`),i.value=R.join(" ")},ze=()=>{V=setInterval(()=>{Ne()},1e3)};he(()=>{re&&ze()});const Ae=W(async g=>{var _,s;try{console.log(q),await y.post(`/story/${q}`,{chapterName:g.newChapterName,content:g.newChapterContent}),A({text:"延伸內容提交成功",snackbarProps:{color:"green"}}),T.value=!1,h("update")}catch(r){console.log(r),A({text:((s=(_=r==null?void 0:r.response)==null?void 0:_.data)==null?void 0:s.message)||"發生錯誤",snackbarProps:{color:"red"}})}});ge(()=>{clearInterval(V)}),Fe(()=>P.content,g=>{ne.value=g[0].content});const Me=g=>{let _=!1,s=!1;for(const r of w.value)r.voteCount.indexOf(n)>-1&&(_=!0,r._id===g._id&&(s=!0));return{hasVoted:_,voteThis:s}};return(g,_)=>(f(),$(Ke,{class:"customMb"},{default:t(()=>[e(Ze,null,{default:t(()=>[e(Je,null,{default:t(()=>[e(C,{"no-gutters":""},{default:t(()=>[e(c,{class:"d-flex align-center justify-center text--secondary",style:{"padding-right":"24px"},cols:"1"},{default:t(()=>[l("div",pt,d(a(be)),1)]),_:1}),e(c,{cols:"8",class:"text--secondary"},{default:t(()=>[l("span",ft,d(a(Ve)),1),mt,a(w)&&a(w).length>0?(f(),k("span",_t,"投票倒數計時：")):ee("",!0),ht,l("span",null,d(a(we)),1)]),_:1}),e(c,{cols:"3",class:"text-right",style:{color:"#4e9194"}},{default:t(()=>{var s;return[l("span",gt,d((s=a(Ce))==null?void 0:s.username),1),xt,a(w)&&a(w).length>0?(f(),k("span",vt,d(i.value),1)):ee("",!0),yt,l("span",bt,d(new Date(a(ke)).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})),1)]}),_:1})]),_:1})]),_:1}),e(pe,null,{default:t(()=>[e(C,{style:{padding:"12px"}},{default:t(()=>[e(c,{cols:"12",class:"mt-1 pa-0",style:{"font-size":"8px"}},{default:t(()=>[l("h1",null,d(a(J)[0].latestContent?"最新內容":"開始故事"),1)]),_:1}),e(c,{cols:"12"},{default:t(()=>[e(C,null,{default:t(()=>[e(c,{cols:"1",class:"d-flex align-center justify-center pa-0"},{default:t(()=>[e(N,{text:"",ripple:!1,variant:"text",class:Re(["heart-button pa-0",{filled:v.value}]),onClick:$e},{default:t(()=>[e(Y,null,{default:t(()=>[p(d(Ie.value),1)]),_:1})]),_:1},8,["class"])]),_:1}),e(c,{cols:"11",class:"pl-0"},{default:t(()=>[l("p",Vt,d(ne.value.join("")),1),e(ae,null,{default:t(()=>[e(Ue),e(N,{color:"secondary",variant:"outlined",onClick:Se},{default:t(()=>[p(" 延續故事 ")]),_:1})]),_:1}),e(He,{modelValue:T.value,"onUpdate:modelValue":_[2]||(_[2]=s=>T.value=s),"max-width":"500"},{default:t(()=>[e(et,{onSubmit:Le(a(Ae),["prevent"]),disabled:a(D)},{default:t(()=>[e(X,null,{default:t(()=>[e(Q,{class:"text-center",style:{"background-color":"#97d8c4"}},{default:t(()=>[p("延續故事")]),_:1}),e(L,{class:"py-4 pb-0"},{default:t(()=>[e(Oe,{modelValue:a(B).value.value,"onUpdate:modelValue":_[0]||(_[0]=s=>a(B).value.value=s),class:"mb-4",label:"輸入章節名稱","hide-details":"",minlength:1,maxlength:60},null,8,["modelValue"]),e(tt,{modelValue:a(x).value.value,"onUpdate:modelValue":_[1]||(_[1]=s=>a(x).value.value=s),label:`故事內容（字數：${S.value} - ${j.value} 字`,rows:"10",minlength:`${S.value}`,maxlength:`${j.value}`,counter:"",rules:je.value,style:{"margin-bottom":"8px"}},null,8,["modelValue","label","minlength","maxlength","rules"])]),_:1}),e(ae,{class:"justify-center align-start py-0"},{default:t(()=>[e(N,{style:{"background-color":"#4e9194",color:"#000000"},type:"submit",loading:a(D)},{default:t(()=>[p("發布")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit","disabled"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(w)&&a(w).length>0?(f(),$(pe,{key:0},{default:t(()=>[e(c,{cols:"12",class:"mt-1 mb-3 pa-0",style:{"font-size":"8px"}},{default:t(()=>[wt]),_:1}),(f(!0),k(z,null,E(a(w).slice(0,5),(s,r)=>(f(),$(dt,{key:r,storyId:a(q),extensionId:s._id,content:s.content,chapterName:s.chapterName,author:s.author,voteCount:s.voteCount,voteStatus:Me(s)},null,8,["storyId","extensionId","content","chapterName","author","voteCount","voteStatus"]))),128))]),_:1})):ee("",!0)]),_:1})]),_:1}))}},kt=le(Ct,[["__scopeId","data-v-89d7747f"]]),$t={class:"pa-0 px-4"},It=l("h2",null,"追蹤故事",-1),St=l("h2",null,"熱門故事",-1),jt=l("h2",null,"最新故事",-1),Tt=l("h2",null,"完結故事",-1),Nt=l("h2",null,"創作資源區",-1),Wt={__name:"index",setup(o){const{api:m}=oe(),u=b([]),n=async()=>{try{const{data:y}=await m.get("/story");u.value=y.result.data}catch(y){console.log("Error loading stories:",y)}},h=[{to:"/articleArea",icon:"mdi-lightbulb-on-outline",title:"創作指引",color:"#F9A825"}];return he(()=>{n(),se.on("updateStory",n)}),ge(()=>{se.off("updateStory",n)}),(y,I)=>(f(),k(z,null,[e(C,null,{default:t(()=>[e(c,{cols:"12"},{default:t(()=>[e(X,{class:"rounded-0 px-10 py-auto",height:"200px",color:"surface-variant",image:"https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=2948&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",cover:"",elevation:"5"},{default:t(()=>[e(c,null,{default:t(()=>[e(Q,{class:"text-h4 font-weight-bold"},{default:t(()=>[p(" 歡迎來到界筆！ ")]),_:1}),e(L,{class:"font-weight-bold pa-0 py-2 px-4 mb-2",style:{"font-size":"24px","letter-spacing":"12px"}},{default:t(()=>[p(" 探索和創作無限可能的故事 ")]),_:1}),l("div",$t,[e(N,{class:"font-weight-black mr-3 px-4",variant:"elevated",color:"#CCB78E",to:"/createStory"},{default:t(()=>[p(" 立即創作 ")]),_:1}),e(N,{class:"font-weight-black px-4",outlined:"",border:"",variant:"elevated",style:{color:"#ccb78e",border:"1px solid #ccb78e","background-color":"rgba(0, 0, 0, 0.47)"},to:"/category"},{default:t(()=>[p(" 探索故事 ")]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1}),e(U,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(c,{cols:"12",class:"pb-0"},{default:t(()=>[It]),_:1}),e(H,{class:"mb-3"}),e(c,{cols:"12",class:"d-flex flex-column justify-space-between"},{default:t(()=>[(f(!0),k(z,null,E(u.value,i=>(f(),$(kt,G({key:i._id,ref_for:!0},i,{onUpdate:n}),null,16))),128))]),_:1})]),_:1})]),_:1}),e(U,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(c,{cols:"12",class:"pb-0"},{default:t(()=>[St]),_:1}),e(H,{class:"mb-3"}),e(c,{cols:"12",class:"d-flex flex-row justify-start"},{default:t(()=>[(f(!0),k(z,null,E(u.value,i=>(f(),$(fe,G({key:i._id,ref_for:!0},i),null,16))),128))]),_:1})]),_:1})]),_:1}),e(U,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(c,{cols:"12",class:"pb-0"},{default:t(()=>[jt]),_:1}),e(H,{class:"mb-3"}),e(c,{cols:"12",class:"d-flex flex-column justify-space-between"})]),_:1})]),_:1}),e(U,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(c,{cols:"12",class:"pb-0"},{default:t(()=>[Tt]),_:1}),e(H,{class:"mb-3"}),e(c,{cols:"12",class:"d-flex flex-row justify-space-between"},{default:t(()=>[(f(!0),k(z,null,E(u.value,i=>(f(),$(fe,G({key:i._id,ref_for:!0},i),null,16))),128))]),_:1})]),_:1})]),_:1}),e(U,{style:{padding:"32px"}},{default:t(()=>[e(C,{class:"justify-space-between"},{default:t(()=>[e(c,{cols:"12",class:"pb-0"},{default:t(()=>[Nt]),_:1}),e(H,{class:"mb-3"}),e(c,{cols:"12",class:"d-flex flex-row justify-space-between py-0"},{default:t(()=>[e(xe,{class:"d-flex justify-space-between w-100 py-0",style:{"background-color":"transparent"}},{default:t(()=>[(f(),k(z,null,E(h,(i,V)=>e(ve,{key:V,to:i.to,link:""},{prepend:t(()=>[e(Y,{size:"80",color:i.color},{default:t(()=>[p(d(i.icon),1)]),_:2},1032,["color"])]),default:t(()=>[e(ye,{style:{"font-size":"20px","font-weight":"bold"},textContent:d(i.title)},null,8,["textContent"])]),_:2},1032,["to"])),64))]),_:1})]),_:1})]),_:1})]),_:1})],64))}};export{Wt as default};
