import{a2 as J,a4 as se,a5 as me,a3 as le,x as k,o as ve,A as oe,a7 as r,aa as v,ac as e,c as a,ad as o,a8 as w,P as N,ag as j,af as K,V as O,ah as g,a9 as m,J as C,G as re,ak as Q,ae as y,ai as H,aF as X,ao as W,at as ne,ax as _e,ay as fe,as as ge,b2 as he,ap as ye}from"./index-DlyiLitO.js";import{m as Y,S as xe}from"./StoryItem-3bu9vccm.js";import{c as be,b as ke,u as Ve,f as Z,V as ee}from"./vee-validate.esm-BgbKjGy5.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{a as V,V as u}from"./VRow-Co7jhYsb.js";import{V as Ce}from"./VMenu-GQH4ndaw.js";import{a as Se,V as ce,b as Ie}from"./VList-cIjzsjcc.js";import{V as te}from"./VTextarea-B8CpUgli.js";import{V as Le}from"./VContainer-B6riO3XD.js";import{V as ae}from"./VChip-D7PB308L.js";import{V as G}from"./VDivider-CHu22zbJ.js";import"./VSlideGroup-D-_92CCE.js";const ue=S=>(_e("data-v-d6cf11f1"),S=S(),fe(),S),Pe=ue(()=>o("h3",{class:"pa-4",style:{"background-color":"rgb(146 224 227)"}},"留言區",-1)),$e={class:"pa-4 pb-1"},Ne={key:1,class:"mr-4 text-body-2"},Ae=ue(()=>o("p",{class:"text-body-1 font-weight-black"},"尚未有留言",-1)),Me={class:"pa-4"},Be={__name:"Message",setup(S){const I=J(),{apiAuth:A,api:T}=ne(),L=se(),U=me(),d=le(),P=J(),t=P.userId,$=P.avatar,M=k([]),B=async()=>{var _,i;try{const l=L.params.id,c=await T.get(`message/${l}`);M.value=c.data.data}catch(l){console.error(l),d({text:((i=(_=l==null?void 0:l.response)==null?void 0:_.data)==null?void 0:i.message)||"發生錯誤",snackbarProps:{color:"red"}})}},E=be({content:ke().required().min(1,"字數不能小於 1")}),{handleSubmit:q,isSubmitting:b,resetForm:D}=Ve({validationSchema:E,initialValues:{isSubmitting:!1,content:"",editContent:""}}),F=Z("content"),n=q(async _=>{var l,c;if(!I.isLogin){d({text:"請先登入才能留言",snackbarProps:{color:"red"}});return}const i={content:_.content,storyId:L.params.id};try{await A.post("/message",i),d({text:"留言成功",snackbarProps:{color:"green"}}),D(),await B()}catch(f){console.error(f),d({text:((c=(l=f==null?void 0:f.response)==null?void 0:l.data)==null?void 0:c.message)||"發生錯誤",snackbarProps:{color:"red"}})}}),h=ve(()=>[{title:"編輯",action:z},{title:"刪除",action:s}]),s=async _=>{var i,l;try{await A.delete(`message/${_._id}`),d({text:"留言已刪除",snackbarProps:{color:"green"}}),await B()}catch(c){console.error(c),d({text:((l=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:l.message)||"發生錯誤",snackbarProps:{color:"red"}})}},x=k(null),p=Z("editContent"),z=_=>{x.value=_._id,p.value.value=_.content},R=async _=>{var i,l;try{b.value=!0,await A.patch(`/message/${_._id}`,{content:p.value.value}),_.content=p.value.value,x.value=null,d({text:"留言已編輯",snackbarProps:{color:"green"}}),D()}catch(c){console.error(c),d({text:((l=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:l.message)||"發生錯誤",snackbarProps:{color:"red"}})}finally{b.value=!1}};function ie(){x.value=null}const de=()=>{I.isLogin||(d({text:"請先登入才能留言",snackbarProps:{color:"red"}}),U.push("/login"))};return oe(()=>{B()}),(_,i)=>(r(),v(W,{style:{"margin-top":"32px"}},{default:e(()=>[Pe,a(V,{class:""},{default:e(()=>[a(u,null,{default:e(()=>[o("div",$e,[M.value.length?(r(),v(V,{key:0},{default:e(()=>[(r(!0),w(N,null,j(M.value,(l,c)=>(r(),w(N,{key:c},[a(u,{class:"d-flex justify-space-between align-center",style:{"padding-bottom":"0px"}},{default:e(()=>[o("div",null,[a(K,{color:"primary",class:"me-3",size:"40"},{default:e(()=>[a(O,{src:l.userId.avatar},null,8,["src"])]),_:2},1024),o("span",null,g(l.userId.username),1)]),m(t)===l.userId._id?(r(),v(Ce,{key:0,location:"end"},{activator:e(({props:f})=>[a(C,re({icon:"",ref_for:!0},f,{class:"menu-btn",style:{width:"30px",height:"30px",padding:"auto"},variant:"plain"}),{default:e(()=>[a(Q,{size:"20"},{default:e(()=>[y("mdi-dots-vertical")]),_:1})]),_:2},1040)]),default:e(()=>[a(Se,{class:"pa-0"},{default:e(()=>[(r(!0),w(N,null,j(h.value,(f,pe)=>(r(),v(ce,{class:"px-4 py-1 my-0",key:pe,onClick:He=>f.action(l),link:""},{default:e(()=>[a(Ie,null,{default:e(()=>[y(g(f.title),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024)):H("",!0)]),_:2},1024),a(u,{cols:"12"},{default:e(()=>[a(V,null,{default:e(()=>[a(u,{cols:"1",class:"pt-0",style:{"max-width":"0px","min-width":"60px"}}),a(u,{class:"pt-0"},{default:e(()=>[x.value===l._id?(r(),v(ee,{key:0,onSubmit:X(f=>R(l),["prevent"]),disabled:m(b)},{default:e(()=>[a(te,{modelValue:m(p).value.value,"onUpdate:modelValue":i[0]||(i[0]=f=>m(p).value.value=f),"error-messages":m(p).errorMessage.value,variant:"outlined",maxlength:"2000","auto-grow":"",rows:"1"},null,8,["modelValue","error-messages"]),a(C,{variant:"flat",color:"#4E9194",class:"mx-1",onClick:ie},{default:e(()=>[y("取消")]),_:1}),a(C,{onClick:f=>R(l),variant:"flat",color:"#4E9194",class:"mx-1",loading:m(b)},{default:e(()=>[y("保存")]),_:2},1032,["onClick","loading"])]),_:2},1032,["onSubmit","disabled"])):(r(),w("p",Ne,g(l.content),1))]),_:2},1024)]),_:2},1024)]),_:2},1024)],64))),128))]),_:1})):(r(),v(V,{key:1,class:"w-100 pa-0 ma-0"},{default:e(()=>[a(u,{class:"text-center my-2 py-0"},{default:e(()=>[Ae]),_:1})]),_:1}))]),o("div",Me,[a(V,null,{default:e(()=>[a(u,{cols:"1",style:{"max-width":"76px"}},{default:e(()=>[a(K,{color:"primary",class:"me-1",size:"large"},{default:e(()=>[m(I).isLogin?(r(),v(O,{key:0,src:m($)},null,8,["src"])):(r(),v(Q,{key:1,icon:"mdi-account",class:"",color:"grey-lighten-2",size:"x-large",style:{color:"black","background-color":"grey",width:"100%",height:"100%"}}))]),_:1})]),_:1}),a(u,{class:"pl-0"},{default:e(()=>[a(ee,{onSubmit:X(m(n),["prevent"]),disabled:m(b),class:"d-flex align-end flex-column"},{default:e(()=>[a(te,{modelValue:m(F).value.value,"onUpdate:modelValue":i[1]||(i[1]=l=>m(F).value.value=l),"error-messages":m(F).errorMessage.value,placeholder:"發表留言...",variant:"outlined",maxlength:"2000","auto-grow":"",rows:"1",class:"w-100","hide-details":"",onFocus:de},null,8,["modelValue","error-messages"]),m(I).isLogin?(r(),v(C,{key:0,variant:"text",class:"rounded-md bg-accent mt-3",density:"default",ripple:!1,type:"submit",style:{"background-color":"#f4b942",width:"120px"}},{default:e(()=>[y("送出")]),_:1})):H("",!0)]),_:1},8,["onSubmit","disabled"])]),_:1})]),_:1})])]),_:1})]),_:1})]),_:1}))}},Ee=we(Be,[["__scopeId","data-v-d6cf11f1"]]),Fe={class:"blue--text text-h5"},We=o("strong",null,"作者：",-1),Te={class:"blue--text"},Ue=o("strong",null,"類別：",-1),De=o("strong",null,"狀態：",-1),ze={class:"orange--text"},Re=o("strong",null,"預計字數：",-1),je={class:"grey--text"},qe={class:"my-2"},Ge=o("h3",{class:""},"起始故事",-1),Je={class:"py-4"},Oe=o("h3",{class:""},"故事投票",-1),nt={__name:"index",props:{story:Object,hasCollection:Boolean},setup(S){const I=S,{api:A,apiAuth:T}=ne(),L=J(),U=se(),d=le(),P=k(I.hasCollection),t=k({_id:"",image:"",title:"",mainAuthor:"",category:"",chapterLabels:"",state:!0,totalWordCount:0,collectionNum:0,followNum:0,content:[]}),$=async()=>{var n,h;try{const{data:s}=await A.get("/story/"+U.params.id);t.value._id=s.result._id,t.value.image=s.result.image,t.value.title=s.result.title,t.value.mainAuthor=s.result.mainAuthor,t.value.category=s.result.category,t.value.chapterLabels=s.result.chapterLabels,t.value.state=s.result.state,t.value.totalWordCount=s.result.totalWordCount,t.value.collectionNum=s.result.collectionNum,t.value.followNum=s.result.followNum,t.value.storyId=s.result._id,t.value.createdAt=s.result.createdAt,t.value.extensions=s.result.extensions,t.value.voteTime=s.result.voteTime,t.value.voteStart=s.result.voteStart,t.value.voteEnd=s.result.voteEnd,t.value.chapters=s.result.chapters,t.value.currentChapterWordCount=s.result.currentChapterWordCount,t.value.wordsPerChapter=s.result.wordsPerChapter,t.value.extendWordLimit=s.result.extendWordLimit,Array.isArray(s.result.content)&&s.result.content.length>0?t.value.content=s.result.content:t.value.content=[],document.title="界筆 | "+t.value.title}catch(s){console.log(s),d({text:((h=(n=s==null?void 0:s.response)==null?void 0:n.data)==null?void 0:h.message)||"發生錯誤",snackbarProps:{color:"red"}})}},M=async()=>{if(!L.isLogin){d({text:"請先登入才能收藏",snackbarProps:{color:"red"}});return}try{const n=await T.post("user/addBookmark",{storyId:t.value._id});P.value=n.data.hasCollection,n.data.hasCollection?t.value.collectionNum++:t.value.collectionNum=Math.max(0,t.value.collectionNum-1),d({text:n.data.hasCollection?"收藏故事":"取消收藏",snackbarProps:{color:"green"}})}catch(n){console.error("收藏操作失败",n),d({text:"收藏操作失败",snackbarProps:{color:"red"}})}},B=async()=>{if(L.isLogin)try{const n=await T.get("user/checkBookmark/"+U.params.id);P.value=n.data.hasCollection}catch(n){console.error("檢查收藏狀態失敗",n)}},E=k(null),q=n=>{E.value=E.value===n?null:n},b=k(!1),D=k([]),F=()=>{b.value=!0};return oe(async()=>{await $(),Y.on("updateStory",$),L.isLogin&&B()}),ge(()=>{Y.off("updateStory",$)}),(n,h)=>(r(),w(N,null,[a(Le,{style:{padding:"32px"}},{default:e(()=>{var s,x;return[a(W,{class:"mb-4 rounded-lg pa-4"},{default:e(()=>[a(V,{class:"pa-4 align-center"},{default:e(()=>[a(u,{cols:"3"},{default:e(()=>[a(O,{src:t.value.image,alt:"書籍封面","aspect-ratio":"1",style:{"border-radius":"8px","box-shadow":"0 2px 4px rgba(0, 0, 0, 0.2)"}},null,8,["src"])]),_:1}),a(u,{cols:"9"},{default:e(()=>[a(V,null,{default:e(()=>[a(u,{cols:"12"},{default:e(()=>[o("h3",Fe,g(t.value.title),1)]),_:1}),a(u,{cols:"12"},{default:e(()=>{var p;return[o("p",null,[We,o("span",Te,g((p=t.value.mainAuthor)==null?void 0:p.username),1)])]}),_:1}),a(u,{cols:"12"},{default:e(()=>[o("p",null,[Ue,y(g(t.value.category),1)])]),_:1}),a(u,{cols:"12"},{default:e(()=>[o("p",null,[De,o("span",ze,g(t.value.state?"完結":"連載"),1)])]),_:1}),a(u,{cols:"12"},{default:e(()=>[o("p",null,[Re,o("span",je,g(t.value.totalWordCount),1)])]),_:1}),a(u,{cols:"12",class:"d-flex"},{default:e(()=>[a(ae,{class:"mr-2 text-white",label:"",style:{"background-color":"#ef5350",color:"white"}},{default:e(()=>[y("收藏數 "+g(t.value.collectionNum),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o("div",qe,[(s=t.value.content[0])!=null&&s._id?(r(),v(C,{key:0,class:"mr-4",style:{"background-color":"#2883d3",color:"white"},to:"/stories/"+t.value._id+"/articles/"+((x=t.value.content[0])==null?void 0:x._id)},{default:e(()=>[y("開始閱讀")]),_:1},8,["to"])):H("",!0),a(C,{class:"mr-4",onClick:h[0]||(h[0]=p=>F(D.value)),style:{"background-color":"#2883d3",color:"white"}},{default:e(()=>[y("章節列表")]),_:1}),a(C,{style:{"background-color":"#2883d3",color:"white"},onClick:M,text:P.value?"取消收藏":"收藏故事"},null,8,["text"])]),a(W,{class:"pa-4 rounded-lg",style:{"margin-top":"32px"}},{default:e(()=>{var p,z;return[Ge,a(G,{class:"my-2"}),o("p",Je,g((z=(p=t.value.content[0])==null?void 0:p.content)==null?void 0:z[0]),1),(r(!0),w(N,null,j(t.value.chapterLabels,R=>(r(),v(ae,{density:"compact",color:"primary",label:!0,class:"mr-2"},{default:e(()=>[y(g(R),1)]),_:2},1024))),256))]}),_:1}),a(W,{class:"pa-4 rounded-lg",style:{"margin-top":"32px"}},{default:e(()=>[Oe,a(G,{class:"my-6"}),(r(),v(xe,re({key:t.value._id},t.value,{isExpanded:E.value===t.value._id,onToggle:h[1]||(h[1]=p=>q(t.value._id)),onUpdate:$}),null,16,["isExpanded"]))]),_:1}),a(Ee)]}),_:1}),a(he,{modelValue:b.value,"onUpdate:modelValue":h[2]||(h[2]=s=>b.value=s),width:"400",scrollable:""},{default:e(()=>[a(W,{"prepend-icon":"mdi-book",title:"章節列表"},{default:e(()=>[a(G),(r(!0),w(N,null,j(t.value.content,(s,x)=>(r(),v(ye,{key:x,class:"px-4",style:{"max-height":"400px"}},{default:e(()=>[(r(),v(ce,{key:x,to:"/stories/"+t.value._id+"/articles/"+s._id,class:"chapter-link"},{default:e(()=>[y(g(s.chapterName),1)]),_:2},1032,["to"]))]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue"])],64))}};export{nt as default};
